<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>DRM Video Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.1/shaka-player.ui.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.1/controls.min.css" crossorigin="anonymous">
    <style>
        body {
            background-color: black;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        [data-shaka-player-container] {
            position: relative;
            width: 80%;
            max-width: 800px;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border: 2px solid #00f;
            border-radius: 10px;
            overflow: hidden;
        }
        #spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            z-index: 1000;
            display: none;
        }
        #qualitySelector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="spinner">Loading...</div>
    <div data-shaka-player-container>
        <video autoplay muted data-shaka-player id="video"></video>
        <div id="qualitySelector" onclick="showQualityOptions()">Quality</div>
    </div>

    <script>
        let player;

        async function initPlayer() {
            const spinner = document.getElementById("spinner");
            const video = document.getElementById("video");
            const ui = video.ui;
            const controls = ui.getControls();
            player = controls.getPlayer();

            // Show spinner while initializing
            spinner.style.display = "block";

            // Configure DRM and streaming settings
            player.configure({
                drm: {
                    servers: {
                        'com.widevine.alpha': 'https://widevine-license-server-url.com' // Replace with your license server
                    },
                    clearKeys: {
                        'ae26845bd33038a9c0774a0981007294': '63ac662dde310cfb4cc6f9b43b34196d' // Replace with your keys
                    },
                },
                streaming: {
                    rebufferingGoal: 3, // Minimal buffering
                    bufferingGoal: 6, // Maintain a 6-second buffer
                    retryParameters: {
                        maxAttempts: 5,
                        baseDelay: 500,
                        backoffFactor: 1.5,
                        fuzzFactor: 0.3
                    }
                },
                abr: {
                    enabled: true,
                    defaultBandwidthEstimate: 3000000 // Fast start (3 Mbps)
                }
            });

            // Handle player errors
            player.addEventListener("error", onPlayerError);

            // Load video stream
            try {
                await player.load("https://ottb.live.cf.ww.aiv-cdn.net/lhr-nitro/live/clients/dash/enc/wf8usag51e/out/v1/bd3b0c314fff4bb1ab4693358f3cd2d3/cenc.mpd"); // Replace with your MPD URL
                console.log("Video loaded successfully!");
            } catch (error) {
                onPlayerError(error);
            } finally {
                spinner.style.display = "none"; // Hide spinner after loading
            }

            console.log("Player initialized successfully.");
        }

        function onPlayerError(error) {
            console.error("Player error:", error);
            alert(`Playback error: ${error.message}`);
        }

        function showQualityOptions() {
            const tracks = player.getVariantTracks();
            const qualityOptions = tracks.map(track => ({
                label: `${track.height}p`,
                id: track.id
            }));

            let qualityMenu = "Select Quality:\n";
            qualityOptions.forEach((option, index) => {
                qualityMenu += `${index + 1}. ${option.label}\n`;
            });

            const selection = prompt(qualityMenu);

            if (selection && !isNaN(selection) && selection > 0 && selection <= qualityOptions.length) {
                const trackId = qualityOptions[selection - 1].id;
                player.selectVariantTrack(tracks.find(track => track.id === trackId), true);
                console.log(`Selected quality: ${qualityOptions[selection - 1].label}`);
            } else {
                console.log("No valid quality selected.");
            }
        }

        // Initialize player when the Shaka UI is ready
        document.addEventListener("shaka-ui-loaded", initPlayer);
    </script>
</body>
</html>